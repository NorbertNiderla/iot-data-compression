#include <stdio.h>
#include <stdint.h>
#include <stdlib.h>

#include "../../../compression_iot/archive/sprintz-huffman-ver.3/huffman.h"
#include "../../../compression_iot/archive/sprintz-huffman-ver.3/sprintz.h"
#include "xtimer.h"

#define SET_SIZE 112
#define SETS 5

int main(void)
{
	const uint16_t data[40][14] = {{70,59,86,72,50,52,60,119,51,71,9861,38,354,120},
									{264,239,81,0,0,2077,0,245,56,88,9909,106,355,120},
									{259,238,84,0,0,2077,0,217,21,51,9905,40,355,119},
									{260,243,87,24,5,2082,60,258,45,67,9924,22,355,120},
									{247,232,89,6,39,2121,60,73,7,14,9900,164,355,118},
									{262,243,85,0,0,2121,0,204,37,61,9880,429,354,120},
									{276,241,75,0,0,2121,0,210,60,106,9852,391,355,119},
									{277,245,77,0,0,2121,0,214,55,124,9841,193,355,119},

									{286,252,76,0,0,2121,0,235,66,124,9847,351,355,119},
									{288,255,77,0,0,2121,0,220,62,121,9837,103,356,120},
									{292,258,77,0,0,2121,0,251,44,67,9849,16,355,120},
									{291,256,76,0,0,2121,0,253,49,100,9848,2,355,120},
									{288,254,77,0,0,2121,0,243,41,61,9852,0,355,120},
									{289,255,77,48,1,2122,60,255,63,109,9848,0,355,119},
									{262,219,69,0,1,2123,0,268,89,138,9851,0,355,119},
									{248,228,84,0,0,2123,0,250,32,46,9869,0,355,119},

									{250,231,85,0,0,2123,0,266,22,42,9870,0,355,119},
									{247,230,87,0,0,2123,0,322,15,41,9881,1,355,120},
									{248,217,76,0,0,2123,0,336,34,62,9888,1,355,120},
									{214,182,74,0,0,2123,0,4,39,76,9899,4,355,119},
									{199,174,78,0,0,2123,0,0,34,72,9911,48,355,119},
									{207,167,67,0,0,2123,0,354,33,75,9920,194,357,119},
									{199,162,69,0,0,2123,0,10,43,77,9929,366,356,120},
									{203,161,65,0,0,2123,0,11,36,53,9942,540,356,120},

									{185,157,75,0,0,2123,0,43,48,96,9949,690,356,120},
									{185,159,76,0,0,2123,0,64,34,56,9953,810,355,120},
									{187,160,76,0,0,2123,0,79,31,44,9959,819,355,119},
									{187,155,72,0,0,2123,0,124,6,10,9960,881,354,119},
									{196,160,69,0,0,2123,0,165,0,10,9958,879,354,120},
									{196,164,72,0,0,2123,0,165,9,23,9960,809,354,119},
									{192,160,73,0,0,2123,0,127,6,11,9959,682,353,119},
									{192,163,75,0,0,2123,0,131,5,9,9958,523,353,120},

									{192,163,75,0,0,2123,0,0,0,5,9963,253,354,119},
									{186,160,77,0,0,2123,0,87,21,34,9966,154,354,119},
									{180,153,76,0,0,2123,0,105,7,15,9965,33,354,119},
									{177,153,78,0,0,2123,0,117,0,11,9963,2,354,119},
									{182,156,77,0,0,2123,0,95,9,13,9968,2,355,119},
									{183,154,75,0,0,2123,0,95,5,8,9970,2,355,120},
									{245,219,80,0,0,2123,0,247,33,43,9866,1,355,119},
									{175,155,81,0,0,2123,0,63,8,17,9963,2,354,119}};
/*
									{177,157,82,0,0,2123,0,0,0,6,9971,2,355,119},
									{180,161,83,0,0,2123,0,114,3,7,9974,2,355,119},
									{182,156,77,0,0,2123,0,178,10,12,9978,2,355,119},
									{190,156,71,0,0,2123,0,190,28,39,9984,3,355,120},
									{192,154,67,0,0,2123,0,203,14,35,9985,57,355,119},
									{198,164,71,0,0,2123,0,222,14,29,9987,106,354,120},
									{203,172,74,0,0,2123,0,218,15,21,9984,147,355,120},
									{210,178,73,0,0,2123,0,198,8,12,9984,171,355,120},

									{205,177,76,0,0,2123,0,161,8,13,9982,276,355,119},
									{204,183,82,0,0,2123,0,157,3,7,9976,514,355,119},
									{208,184,80,0,0,2123,0,137,5,16,9988,736,355,119},
									{247,185,56,0,0,2123,0,250,40,51,9985,491,356,120},
									{248,175,49,0,0,2123,0,253,40,64,9977,490,356,120},
									{251,179,50,0,0,2123,0,239,32,52,9970,559,355,120},
									{253,182,51,0,0,2123,0,265,13,30,9965,408,354,120},
									{240,180,56,0,0,2123,0,86,11,23,9958,284,354,119},

									{241,182,57,0,0,2123,0,230,7,17,9966,84,355,120},
									{246,186,56,0,0,2123,0,257,15,34,9956,30,355,119},
									{239,188,62,0,0,2123,0,202,13,23,9951,9,355,120},
									{225,185,69,0,0,2123,0,181,13,24,9949,1,355,120},
									{231,187,66,0,0,2123,0,250,22,39,9958,1,355,119},
									{225,186,69,0,0,2123,0,0,0,0,9955,1,355,120},
									{178,159,82,0,0,2123,0,51,6,9,9966,2,355,119},
									{217,185,74,0,0,2123,0,242,13,23,9946,1,355,119},

									{215,188,78,0,0,2123,0,185,18,30,9932,1,354,120},
									{210,193,86,66,23,2146,60,241,27,49,9925,1,354,120},
									{195,189,95,48,74,2220,60,15,26,41,9928,2,355,120},
									{191,189,97,126,80,2300,60,198,8,16,9930,2,355,120},
									{199,192,94,0,59,2359,0,161,11,34,9925,6,355,119},
									{202,196,95,0,0,2359,0,184,21,34,9925,12,355,119},
									{206,201,95,0,0,2359,0,195,26,39,9921,149,354,119},
									{217,207,92,0,0,2359,0,211,22,52,9918,404,355,119},

									{235,214,83,0,0,2359,0,235,14,30,9917,673,356,120},
									{259,220,72,0,0,2359,0,285,20,35,9919,530,356,120},
									{228,207,83,0,0,2359,0,90,17,22,9915,260,354,119},
									{188,184,96,0,0,2359,0,51,11,24,9916,88,355,119},
									{198,193,96,0,1,2360,0,25,22,30,9917,131,355,120},
									{196,191,96,0,0,2360,0,17,27,37,9918,270,353,119},
									{201,196,96,0,0,2360,0,15,32,41,9920,57,354,120},
									{186,183,98,0,0,2360,0,15,39,52,9921,65,354,119}};

									{173,173,100,0,1,2361,0,11,44,72,9921,46,354,119},
									{174,174,100,0,0,2361,0,16,44,61,9916,9,355,119},
									{173,173,100,0,0,2361,0,20,22,41,9921,2,354,119},
									{168,168,100,0,0,2361,0,17,34,59,9922,2,355,119},
									{175,161,87,0,0,2361,0,3,29,51,9938,2,354,120},
									{218,185,73,0,0,2123,0,212,9,17,9953,1,355,119},
									{172,160,89,0,0,2361,0,11,50,81,9921,2,354,120},
									{166,156,90,0,0,2361,0,11,65,95,9919,2,355,119},

									{165,157,92,0,0,2361,0,16,41,65,9912,2,355,119},
									{162,157,94,0,0,2361,0,10,50,88,9915,2,355,119},
									{155,152,98,0,0,2361,0,7,32,63,9925,3,354,119},
									{158,158,100,0,0,2361,0,14,30,52,9930,12,354,119},
									{162,163,100,0,0,2361,0,355,28,66,9937,24,354,120},
									{160,160,100,0,0,2361,0,1,37,72,9937,43,354,119},
									{168,168,100,0,0,2361,0,12,49,71,9934,81,355,119},
									{172,167,95,0,0,2361,0,66,38,57,9928,106,355,119},

									{175,168,93,0,0,2361,0,71,52,71,9924,197,354,119},
									{174,167,93,0,0,2361,0,67,45,63,9928,55,355,119},
									{173,168,95,0,0,2361,0,63,31,57,9928,111,355,120},
									{173,169,96,0,0,2361,0,64,31,53,9921,110,354,120},
									{171,168,97,102,44,2405,60,28,40,59,9920,46,355,119},
									{170,164,95,66,48,2453,60,4,44,78,9923,50,355,119},
									{167,164,97,36,66,2519,60,10,54,82,9923,24,354,119},
									{162,158,96,12,98,2617,60,8,44,78,9927,27,354,119},

									{164,160,96,48,59,2676,60,26,48,85,9924,11,354,119},
									{162,157,95,48,70,2746,60,16,61,88,9922,5,354,119},
									{164,158,95,0,19,2765,60,14,61,89,9920,3,354,119},
									{173,167,95,0,9,2774,60,28,50,78,9928,2,354,119},
									{166,160,94,0,21,2795,60,17,43,64,9928,3,355,119},
									{176,158,83,0,0,2361,0,8,34,57,9924,2,355,120},
									{165,158,94,12,6,2805,60,354,32,47,9920,2,354,117},
									{163,155,93,0,3,2808,0,0,48,81,9912,2,354,119},

									{169,158,90,0,0,2808,0,11,31,53,9909,2,354,119},
									{166,153,88,0,0,2808,0,15,41,78,9908,2,354,119},
									{166,151,86,0,0,2808,0,2,34,63,9911,3,355,119},
									{162,148,87,0,0,2808,0,14,53,90,9913,21,354,119},
									{161,146,86,0,0,2808,0,4,43,89,9915,113,355,119},
									{157,142,86,0,0,2808,0,11,74,114,9920,164,355,120},
									{158,142,85,0,0,2808,0,9,58,111,9924,435,356,119},
									{160,143,84,0,0,2808,0,7,57,98,9925,593,355,120},

									{164,146,83,0,0,2808,0,13,67,83,9931,775,355,120},
									{166,148,83,0,0,2808,0,10,62,99,9933,888,355,119},
									{170,150,82,0,0,2808,0,9,57,84,9935,915,354,120},
									{178,157,81,0,0,2808,0,9,42,70,9931,890,354,119},
									{181,157,79,0,0,2808,0,15,40,71,9930,834,353,119},
									{181,154,75,0,0,2808,0,8,48,86,9928,439,354,119},
									{189,155,70,0,0,2808,0,4,41,77,9926,582,353,119},
									{192,159,72,0,0,2808,0,18,40,60,9923,370,353,120},

									{179,155,78,0,0,2808,0,8,30,55,9921,188,354,120},
									{176,149,76,0,0,2808,0,14,37,53,9917,24,354,119},
									{182,146,68,0,0,2808,0,7,32,57,9916,2,355,119},
									{179,144,69,0,0,2808,0,3,23,47,9915,2,355,119},
									{184,140,62,0,0,2808,0,1,27,43,9913,2,354,119},
									{165,159,95,0,4,2799,60,15,35,48,9925,3,355,119},
									{164,133,71,0,0,2808,0,268,16,19,9910,3,354,119},
									{160,130,72,0,0,2808,0,261,18,27,9908,3,354,119},

									{156,129,74,0,0,2808,0,258,14,17,9905,3,355,119},
									{150,133,83,0,0,2808,60,262,12,14,9907,3,355,119},
									{155,132,78,0,0,2808,0,0,0,4,9910,41,355,119},
									{186,149,68,0,0,2808,0,0,0,4,9911,175,356,119},
									{199,154,63,0,0,2808,0,226,5,7,9917,350,356,119},
									{203,151,58,0,0,2808,0,101,11,18,9914,531,356,119},
									{189,158,73,0,0,2808,0,116,7,11,9912,678,356,120},
									{197,166,74,0,0,2808,0,132,4,8,9907,800,355,119},

									{205,172,72,0,0,2808,0,154,9,19,9902,908,355,120},
									{207,168,68,0,0,2808,0,110,12,31,9897,854,355,120},
									{211,161,60,0,0,2808,0,98,29,49,9892,690,354,119},
									{208,162,63,0,0,2808,0,117,9,19,9887,713,354,119},
									{209,162,63,0,0,2808,0,163,7,23,9882,202,355,119},
									{227,179,63,0,0,2808,0,240,35,64,9883,60,355,120},
									{229,182,64,6,0,2809,60,206,16,29,9880,95,355,120},
									{227,182,65,6,1,2810,60,239,18,30,9879,45,354,120},

									{228,177,61,0,0,2810,0,187,22,29,9878,5,355,120},
									{206,177,76,0,1,2811,60,129,6,15,9875,1,355,119},
									{203,173,74,0,0,2811,60,162,19,45,9881,2,354,119},
									{210,182,77,0,0,2811,0,256,21,32,9882,1,355,119},
									{182,135,60,0,0,2808,0,356,19,30,9915,2,355,119},
									{204,178,78,0,0,2811,0,184,13,17,9875,1,355,120},
									{201,182,84,0,0,2811,0,168,22,35,9868,2,355,120},
									{197,182,87,0,0,2811,0,114,5,7,9866,2,355,119}};

									{195,182,89,0,0,2811,0,0,0,5,9865,2,355,119},
									{188,181,94,0,0,2811,0,157,9,14,9865,2,355,119},
									{188,182,94,0,6,2817,60,165,11,19,9865,11,354,119},
									{184,180,96,0,13,2830,60,97,10,17,9869,38,355,119},
									{185,180,96,0,5,2835,0,158,5,14,9872,65,354,119},
									{184,179,95,0,0,2835,0,111,6,9,9873,185,355,120},
									{188,182,94,0,0,2835,0,102,26,36,9870,423,355,120},
									{185,180,95,0,0,2835,0,98,26,38,9871,285,355,119}};*/

	xtimer_ticks32_t timestamp_1 = xtimer_now();

	buildTree();

	xtimer_ticks32_t timestamp_2 = xtimer_now();

	buildLookUpTable();

	xtimer_ticks32_t timestamp_3 = xtimer_now();

	unsigned char* data_encoded = (unsigned char*)malloc(sizeof(unsigned char)*SETS*SET_SIZE*2);
	int bits = sprintz((uint16_t*)&data, SETS, data_encoded);

	xtimer_ticks32_t timestamp_4 = xtimer_now();

	uint16_t* data_de = (uint16_t*)malloc(sizeof(uint16_t)*SETS*SET_SIZE);
	sprintzDecode(data_encoded, SETS, data_de);

	xtimer_ticks32_t timestamp_5 = xtimer_now();

	int check = 1;
	for(int k=0;k<SETS*8;k++)
		for (int i = 0; i < 14; i++)
		{
			if(data_de[k*14+i]!=data[k][i])
			{
				check = 0;
				printf("%d %d %d\n",k,i,data_de[k*14+i]-data[k][i]);
			}
		}	

	if(check==1) printf("Sprintz works properly!\n\n");
	else printf("Sprintz is not working!\n\n");

	xtimer_ticks32_t tree_time =xtimer_diff(timestamp_2,timestamp_1);
	xtimer_ticks32_t table_time =xtimer_diff(timestamp_3,timestamp_2);
	xtimer_ticks32_t encode_time =xtimer_diff(timestamp_4,timestamp_3);
	xtimer_ticks32_t decode_time =xtimer_diff(timestamp_5,timestamp_4);

	printf("Build Huffman tree time: %u\n",(unsigned int)tree_time.ticks32);
	printf("Build Huffman lookup table time: %u\n",(unsigned int)table_time.ticks32);
	printf("Encode time: %u\n",(unsigned int)encode_time.ticks32);
	printf("Decode time: %u\n",(unsigned int)decode_time.ticks32);

	float compression_ratio = (float)(SET_SIZE*SETS*2*8)/bits;
	printf("\nCompression ratio: %d\n",(int)(compression_ratio*100));
	
	free(data_de);
	free(data_encoded);
	return 0;
}
